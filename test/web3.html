<!DOCTYPE html>
<html lang="en">
  <style>
   /* CSS สำหรับตาราง */
   #resultTable {
      border-collapse: collapse;
      width: 100%;
      border: 1px solid black;
      border-radius: 5px; /* กำหนดขนาดของการโค้ง */
      overflow: hidden; /* คำสั่งนี้จำเป็นสำหรับทำให้การเกิดเส้นโค้งเป็นไปได้ */
    }

    #resultTable th,
    #resultTable td {
      border: 1px solid rgba(0, 0, 0, 0);
      padding: 8px;
      text-align: left;
    }

    #resultTable th {
      background-color: lightgray; /* สีพื้นหลังสำหรับส่วนหัว */
    }

    /* สำหรับตารางข้อมูล */
    #resultBody tr:nth-child(even) {
      background-color: #cfcfcfa3; /* สีพื้นหลังสำหรับแถวคู่ */
    }

    /* สำหรับตารางข้อมูล */
    #resultBody tr:nth-child(odd) {
      background-color: #7a7a7aa2; /* สีพื้นหลังสำหรับแถวคี่ */
    }
  </style>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Selling Movie</title>
    <link rel="stylesheet" type="text/css" href="main.css" />
    <!-- <script src="./node_modules/web3/dist/web3.min.js">
    </script> -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.3/dist/web3.min.js"></script>
  </head>

  <body>
    <header>
      <h1 style="text-align: center">Welcome to Blockchain Movie</h1>
      <h3 class="fixed">โปรดเลือกหนังที่ท่านต้องการ</h3>
    </header>

    <main>
      <div class="container">
        <!-- <h1>Welcome to MovieLand</h1> -->
        <div class="movie-container">
          <div class="movie">
            <img src="image/movie1.jpg" alt="Movie 1" />
            <h2>The Fast and the Furious: Tokyo Drift</h2>
            <span>2006 | Maturity Rating:13+ | 1h 44m | Crime</span>
            <p>
              A teenager becomes a major competitor in the world of drift racing
              after moving in with his father in Tokyo to avoid a jail sentence
              in America.
            </p>
            <label
              style="text-align: center; font-size: large; margin-top: 22px"
              >Price: 0.001 Ether</label
            >
            <button id="btnRegistrationFast">Buy</button>
          </div>
          <div class="movie">
            <img src="image/movie2.jpeg" alt="Movie 2" />
            <h2>The Martian</h2>
            <span>2015 | Maturity Rating:13+ | 2h 24m | Drama</span>
            <p>
              An astronaut becomes stranded on Mars after his team assume him
              dead, and must rely on his ingenuity to find a way to signal to
              Earth that he is alive and can survive until a potential rescue.
            </p>
            <label style="text-align: center; font-size: large"
              >Price: 0.002 Ether</label
            >
            <button id="btnRegistrationMartian">Buy</button>
          </div>
          <div class="movie">
            <img src="image/movie3.jpg" alt="Movie 3" />
            <h2>Iron Man 3</h2>
            <span>2016 | Maturity Rating:13+ | 1h 26m | Drama</span>
            <p>
              When Tony Stark's world is torn apart by a formidable terrorist
              called the Mandarin, he starts an odyssey of rebuilding and
              retribution.
            </p>
            <!-- <input id="document1" type="text"> -->
            <label
              style="text-align: center; font-size: large; margin-top: 22px"
              >Price: 0.003 Ether</label
            >
            <button id="btnRegistrationIron">Buy</button>
          </div>
          <div class="movie">
            <img src="image/movie4.jpg" alt="Movie 4" />
            <h2>Mission: Impossible - Ghost Protocol</h2>
            <span>2011 | Maturity Rating:13+ | 2h 12m | Action</span>
            <!-- <input id="document1" type="text"> -->
            <p>
              The IMF is shut down when it's implicated in the bombing of the
              Kremlin, causing Ethan Hunt and his new team to go rogue to clear
              their organization's name.
            </p>
            <label
              style="text-align: center; font-size: large; margin-top: 23px"
              >Price: 0.004 Ether</label
            >
            <button id="btnRegistrationMission">Buy</button>
          </div>
          <div class="movie">
            <img src="image/movie5.jpg" alt="Movie 5" />
            <h2>Casino Royale</h2>
            <span>2006 | Maturity Rating:13+ | 2h 24m | Action</span>
            <p>
              After earning 00 status and a licence to kill, secret agent James
              Bond sets out on his first mission as 007. Bond must defeat a
              private banker funding terrorists in a high-stakes game of poker
              at Casino Royale, Montenegro."
            </p>
            <!-- <input id="document1" type="text"> -->
            <label style="text-align: center; font-size: large"
              >Price: 0.005 Ether</label
            >
            <button id="btnRegistrationCasino" >Buy</button>
          </div>
          <div class="movie">
            <img src="image/movie6.jpg" alt="Movie 6" />
            <h2>Angel Has Fallen</h2>
            <span>2019 | Maturity Rating:16+ | 2h 1m | Action</span>
            <p>
              Mike Banning is framed for the attempted assassination of the
              President and must evade his own agency and the FBI as he tries to
              uncover the real threat.
            </p>
            <!-- <input id="document1" type="text"> -->
            <label
              style="text-align: center; font-size: large; margin-top: 23px"
              >Price: 0.006 Ether</label
            >
            <button id="btnRegistrationAngel">Buy</button>
          </div>
        </div>
      </div>
      <div class="table-container" style="margin-top: 50px; width: 70%">
        <!-- Mocking up some data -->
        <h1>ตารางเวลา</h1>
        <button id="btnCheck">Check the Owner</button>
        <div>
            <table style="width:100%">
                <tr style="height:50px">
                    <th>Owner (address)</th>
                    <th>Title</th>
                    <th>Time</th>
                </tr>
                <tr style="height:36px">
                    <td id="result1"></td>
                    <td id="titleMovie1"></td>
                    <td id="buyTime1"></td>
                </tr>
                <tr style="height:36px">
                    <td id="result2"></td>
                    <td id="titleMovie2"></td>
                    <td id="buyTime2"></td>
                </tr>
                <tr style="height:36px">
                    <td id="result3"></td>
                    <td id="titleMovie3"></td>
                    <td id="buyTime3"></td>
                </tr>
                <tr style="height:36px">
                    <td id="result4"></td>
                    <td id="titleMovie4"></td>
                    <td id="buyTime4"></td>
                </tr>
                <tr style="height:36px">
                    <td id="result5"></td>
                    <td id="titleMovie5"></td>
                    <td id="buyTime5"></td>
                </tr>
                <tr style="height:36px">
                    <td id="result6"></td>
                    <td id="titleMovie6"></td>
                    <td id="buyTime6"></td>
                </tr>
            </table>
      </div>
    </main>

    <footer>
      <!-- <div class="container">
        Status: <span id="status" style="color:green;">Loading...</span>
        <span id="currentAccount"></span>
      </div> -->
      <h2 id="status" style="border-radius: 5px; color: rgb(6, 250, 46)">Status...</h2>
      <span id="currentAccount"></span>
    </footer>
    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"></script>
    <script>
     // ===Connecting to MetaMask===
     function loadWeb3() {
                if (window.ethereum) {
                    // To get web3(.js) object
                    web3 = new Web3(window.ethereum);

                    // To request user's account from Metamask
                    ethereum
                        .request({ method: 'eth_requestAccounts' })
                        .then(handleAccountsChanged)
                        .catch((err) => {
                            if (err.code === 4001) {
                                // If this happens, the user rejected the connection request.
                                console.log('Please connect to MetaMask.');
                            } else {
                                console.error(err);
                            }
                        });
                }
            }

            // ===Handle user accounts and accountsChanged===
            let currentAccount = null;

            // Note that this event is emitted on page load.
            // If the array of accounts is non-empty, you're already connected.
            window.ethereum.on('accountsChanged', handleAccountsChanged);

            // For now, 'eth_accounts' will continue to always return an array
            function handleAccountsChanged(accounts) {
                if (accounts.length === 0) {
                    // MetaMask is locked or the user has not connected any accounts
                    console.log('Please connect to MetaMask.');
                } else if (accounts[0] !== currentAccount) {
                    currentAccount = accounts[0];
                }
            }

            let abi = [
                {
                    "anonymous": false,
                    "inputs": [
                        {
                            "indexed": false,
                            "internalType": "address",
                            "name": "from",
                            "type": "address"
                        },
                        {
                            "indexed": false,
                            "internalType": "string",
                            "name": "text",
                            "type": "string"
                        },
                        {
                            "indexed": false,
                            "internalType": "bytes32",
                            "name": "hash",
                            "type": "bytes32"
                        }
                    ],
                    "name": "NameAdded",
                    "type": "event"
                },
                {
                    "inputs": [
                        {
                            "internalType": "string",
                            "name": "name",
                            "type": "string"
                        }
                    ],
                    "name": "registration",
                    "outputs": [],
                    "stateMutability": "payable",
                    "type": "function"
                },
                {
                    "anonymous": false,
                    "inputs": [
                        {
                            "indexed": false,
                            "internalType": "address",
                            "name": "from",
                            "type": "address"
                        },
                        {
                            "indexed": false,
                            "internalType": "string",
                            "name": "text",
                            "type": "string"
                        },
                        {
                            "indexed": false,
                            "internalType": "string",
                            "name": "reason",
                            "type": "string"
                        }
                    ],
                    "name": "RegistrationError",
                    "type": "event"
                },
                {
                    "inputs": [
                        {
                            "internalType": "string",
                            "name": "name",
                            "type": "string"
                        }
                    ],
                    "name": "checkName",
                    "outputs": [
                        {
                            "internalType": "bool",
                            "name": "",
                            "type": "bool"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                }
            ]

            async function loadContract() {
                return await new web3.eth.Contract(abi, '0x8F7AE1f9580DEb1Be44b0aCE292C1Ec1a7561c43');
            }

            async function load() {
                await loadWeb3();
                web3.contract = await loadContract();
                updateStatus('Ready!');
            }

            function updateStatus(status) {
                const statusEl = document.getElementById('status');
                statusEl.innerHTML = status;
                console.log(status);
            }

      //List หนัง
      $("#btnRegistrationFast").click(function () {
        handleBuy("The Fast and the Furious: Tokyo Drift!", "0.001");
      });
      $("#btnRegistrationMartian").click(function () {
        handleBuy("The Martian!", "0.002");
      });
      $("#btnRegistrationIron").click(function () {
        handleBuy("Iron Man 3!", "0.003");
      });
      $("#btnRegistrationMission").click(function () {
        handleBuy("Mission: Impossible - Ghost Protocol!", "0.004");
      });
      $("#btnRegistrationCasino").click(function () {
        handleBuy("Casino Royale!", "0.005");
      });
      $("#btnRegistrationAngel").click(function () {
        handleBuy("Angel Has Fallen!", "0.006");
      });

      let index = 0;

      async function handleBuy(movie, price) {
                console.log(currentAccount);

                const currentTime = new Date();
                const formattedTime = currentTime.toLocaleTimeString();

                web3.contract.methods.registration(movie)
                    .send({
                        from: currentAccount,
                        value: web3.utils.toWei(price, "ether")
                    }, function (error, result) {
                        if (error) {
                            console.log('Transaction cancelled.');
                            if(index == 0) {
                                index = 0
                                console.log(index)
                            } else if (index > 0) {
                                index--;
                                console.log(index)
                            }
                        } else {
                            $(`#result${index}`).html(result);
                            isTransactionConfirmed = true;
                        }
                    });

                web3.contract.once('NameAdded', {}, function (error, event) {
                    if (!error) {
                        console.log(event);
                        $(`#titleMovie${index}`).html(movie);
                        $(`#buyTime${index}`).html(formattedTime);
                        $(`#result${index}`).html(currentAccount);
                    }
                });

                web3.contract.once('RegistrationError', {}, function (error, event) {
                    if (!error) {
                        console.log(event);
                        $(`#titleMovie${index}`).html("-");
                        $(`#buyTime${index}`).html("-");
                        $(`#result${index}`).html("Error: " + event.returnValues.text + "<br/>Reason: " + event.returnValues.reason);
                    }
                });

                index++;
            }

            load();
        </script>
  </body>
</html>
