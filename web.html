<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Sell Web Page</title>
    <link rel="stylesheet" type="text/css" href="main.css">
    <title>BC Movie</title>
    <!-- <script src="./node_modules/web3/dist/web3.min.js">
    </script> -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.3/dist/web3.min.js"></script>
</head>

<body>
    <header>
            <h1 style="text-align:center">Welcome to Blockchain Movie </h1>  
            <h3 class="fixed">โปรดเลือกหนังที่ท่านต้องการ</h3>
    </header>

    <main>
        <div class="container">
            <!-- <h1>Welcome to MovieLand</h1> -->
            <div class="movie-container">
                <div class="movie">
                    <img src="image/movie1.jpg" alt="Movie 1">
                    <h2>The Fast and the Furious: Tokyo Drift</h2>
                    <span>2006 | Maturity Rating:13+ | 1h 44m | Crime</span>
                    <p>A teenager becomes a major competitor in the world of drift racing after moving in with his father in Tokyo to avoid a jail sentence in America.</p>
                    <label style="text-align: center; font-size: large; margin-top: 22px;">0.5 ETH</label>
                    <button id="document1" onclick="btnPurchase('The Fast and the Furious: Tokyo Drift',0.5)">PurchaseNow</button>
                </div>
                <div class="movie">
                    <img src="image/movie2.jpeg" alt="Movie 2">
                    <h2>The Martian</h2>
                    <span>2015 | Maturity Rating:13+ | 2h 24m | Drama</span>
                    <p>An astronaut becomes stranded on Mars after his team assume him dead, and must rely on his ingenuity to find a way to signal to Earth that he is alive and can survive until a potential rescue.</p>
                    <label style="text-align: center; font-size: large; ">0.8 ETH</label>
                    <button id="document1" onclick="btnPurchase('The Martian',0.5)">PurchaseNow</button>
                </div>
                <div class="movie">
                    <img src="image/movie3.jpg" alt="Movie 3">
                    <h2>Iron Man 3</h2>
                    <span>2016 | Maturity Rating:13+ | 1h 26m | Drama</span>
                    <p>When Tony Stark's world is torn apart by a formidable terrorist called the Mandarin, he starts an odyssey of rebuilding and retribution.</p>
                    <label style="text-align: center; font-size: large; margin-top: 22px;">0.5 ETH</label>
                    <button id="document1" onclick="btnPurchase('Iron Man 3',0.5)">PurchaseNow</button>
                </div>
                <div class="movie">
                    <img src="image/movie4.jpg" alt="Movie 4">
                    <h2>Mission: Impossible - Ghost Protocol</h2>
                    <span>2011 | Maturity Rating:13+ | 2h 12m | Action</span>
                    <p>The IMF is shut down when it's implicated in the bombing of the Kremlin, causing Ethan Hunt and his new team to go rogue to clear their organization's name.</p>
                    <label style="text-align: center; font-size: large; margin-top: 23px; ">0.45 ETH</label>
                    <button id="document1" onclick="btnPurchase('The Martian',0.5)">PurchaseNow</button>
                </div>
                <div class="movie">
                    <img src="image/movie5.jpg" alt="Movie 5">
                    <h2>Casino Royale</h2>
                    <span>2006 | Maturity Rating:13+ | 2h 24m | Action</span>
                    <p>After earning 00 status and a licence to kill, secret agent James Bond sets out on his first mission as 007. Bond must defeat a private banker funding terrorists in a high-stakes game of poker at Casino Royale, Montenegro."</p>
                    <label style="text-align: center; font-size: large; ">0.4 ETH</label>
                    <button id="document1" onclick="btnPurchase('Casino Royale',0.5)">PurchaseNow</button>
                </div>
                <div class="movie">
                    <img src="image/movie6.jpg" alt="Movie 6">
                    <h2>Angel Has Fallen</h2>
                    <span>2019 | Maturity Rating:16+ | 2h 1m | Action</span>
                    <p>Mike Banning is framed for the attempted assassination of the President and must evade his own agency and the FBI as he tries to uncover the real threat.</p>
                    <label style="text-align: center; font-size: large; margin-top: 23px;">0.75 ETH</label>
                    <button id="document1" onclick="btnPurchase('Angel Has Fallen',0.5)">PurchaseNow</button>
                </div>
            </div>
        </div>
        <div class="table-container" style="margin-top: 50px;"> <!-- Mocking up some data -->
            <h1>ตารางเวลา</h1>
            <table>
                <tr>
                    <th>Time</th>
                    <th>Movie</th>
                    <th>Owner</th>
                </tr>
                <tr>
                    <td id="time1"> </td>
                    <td id="movie1"> </td>
                    <td id="owner1"> </td>
                </tr>
                <tr>
                    <td id="time2"> </td>
                    <td id="movie2"> </td>
                    <td id="owner2"> </td>
                </tr>
                <tr>
                    <td id="time3"> </td>
                    <td id="room3"> </td>
                    <td id="owner3"> </td>
                </tr>
                <tr>
                    <td id="time4"> </td>
                    <td id="movie4"> </td>
                    <td id="owner4"> </td>
                </tr>
                <tr>
                    <td id="time5"> </td>
                    <td id="movie5"> </td>
                    <td id="owner5"> </td>
                </tr>
                <tr>
                    <td id="time6"> </td>
                    <td id="movie6"> </td>
                    <td id="owner6"> </td>
                </tr>
            </table>
        </div>
    </main>

    <footer>
        <div class="container">
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"></script>
    <script>

        // ===Connecting to MetaMask===
        function loadWeb3() {
            if (window.ethereum) {
                window.web3 = new Web3(window.ethereum);
                window.ethereum.enable();
                ethereum
                    .request({ method: 'eth_requestAccounts' })
                    .then(accounts => {
                        currentAccount = accounts[0];
                        console.log('Connected to MetaMask. Current account:', currentAccount);
                    })
                    .catch((err) => {
                        if (err.code === 4001) {
                            console.log('Please connect to MetaMask.');
                        } else {
                            console.error(err);
                        }
                    });
                window.ethereum.on('accountsChanged', handleAccountsChanged);
            } else {
                console.log('MetaMask extension not detected. Please install MetaMask.');
            }
        }

        let currentAccount = null;

        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                console.log('Please connect to MetaMask.');
            } else if (accounts[0] !== currentAccount) {
                currentAccount = accounts[0];
                console.log('Current account changed:', currentAccount);
            }
        }

        // Call loadWeb3() function to initiate connection to MetaMask
        loadWeb3();

        // Contract ABI (Application Binary Interface)
        let abi = [{
            "anonymous": false,
            "inputs": [
                {
                    "indexed": false,
                    "internalType": "address",
                    "name": "owner",
                    "type": "address"
                },
                {
                    "indexed": false,
                    "internalType": "string",
                    "name": "movie",
                    "type": "string"
                }
            ],
            "name": "Add",
            "type": "event"
        },
        {
            "inputs": [
                {
                    "internalType": "string",
                    "name": "name",
                    "type": "string"
                }
            ],
            "name": "purchase",
            "outputs": [],
            "stateMutability": "payable",
            "type": "function"
        }
        ];

        // Load Contract
        async function loadContract() {
            return await new web3.eth.Contract(abi, 'xxx'); // 'xxx' should be replaced with your contract address
        }

        async function load() {
            await loadWeb3();
            web3.contract = await loadContract();
            updateStatus('Ready!');
        }

        function updateStatus(status) {
            const statusEl = document.getElementById('status');
            statusEl.innerHTML = status;
            console.log(status);
        }

        function btnPurchase(p, V) {
            console.log(currentAccount);
            window.contract.method.reserve(p).send({ from: currentAccount, value: v }, function (error, result) {
                $("#result").html(result);
            });
            window.contract.once("Add", {}, function (error, event) {
                if (!error) {
                    console.log(event);
                    var h = new Date().getHours()
                    var m = new Date().getMinutes()
                    $("#result").html("Name:" + event.returnValues.movie + "<br/>time:" + h + ":" + m + "<br/>owner:" + event.returnValues.owner);
                    i++;
                    $("#time" + i).html(h + ":" + m);
                    $("#movie" + i).html(event.returnValues.movie)
                    $("#owner" + i).html(event.returnValues.owner)
                }
            })
        };
        load();
    </script>
    
</body>

</html>